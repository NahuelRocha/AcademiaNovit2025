name: Docker Deploy DEV

on:
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  DEPLOY_TAG: production

jobs:
  deploy:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Debug: Verificar archivos locales
      - name: Debug - List local files
        run: |
          echo "ðŸ“ Archivos en el directorio actual:"
          ls -la
          echo "ðŸ” Verificando archivos especÃ­ficos:"
          ls -la nginx.conf docker-swarm.yml || echo "âŒ Algunos archivos no encontrados localmente"

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Crear directorio remoto primero
      - name: Create remote directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          port: ${{ secrets.VM_PORT }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_PRIVATE_KEY }}
          script: |
            echo "ðŸ“ Creando directorio..."
            mkdir -p ~/academianovit-prod
            echo "âœ… Directorio creado/verificado"

      - name: Copy nginx.conf to server
        uses: garygrossgarten/github-action-scp@release
        with:
          local: nginx.conf
          remote: academianovit-prod/nginx.conf
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          privateKey: ${{ secrets.VM_PRIVATE_KEY }}
          port: ${{ secrets.VM_PORT }}

      - name: Copy docker-swarm.yml to server
        uses: garygrossgarten/github-action-scp@release
        with:
          local: docker-swarm.yml
          remote: academianovit-prod/docker-swarm.yml
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          privateKey: ${{ secrets.VM_PRIVATE_KEY }}
          port: ${{ secrets.VM_PORT }}

      # Debug: Verificar archivos copiados
      - name: Debug - Verify copied files
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          port: ${{ secrets.VM_PORT }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_PRIVATE_KEY }}
          script: |
            echo "ðŸ” Debug - Verificando archivos copiados:"
            echo "Directorio home:"
            ls -la ~
            echo ""
            echo "Directorio academianovit-prod:"
            ls -la ~/academianovit-prod/
            echo ""
            echo "Contenido de nginx.conf (primeras 5 lÃ­neas):"
            head -n 5 ~/academianovit-prod/nginx.conf || echo "âŒ nginx.conf no encontrado"
            echo ""
            echo "Contenido de docker-swarm.yml (primeras 5 lÃ­neas):"
            head -n 5 ~/academianovit-prod/docker-swarm.yml || echo "âŒ docker-swarm.yml no encontrado"

      - name: Deploy to production via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          port: ${{ secrets.VM_PORT }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_PRIVATE_KEY }}
          script: |
            set -e

            cd ~/academianovit-prod

            echo "ðŸŒ€ Iniciando despliegue Swarm en producciÃ³n..."

            # Verificar que los archivos existen
            echo "ðŸ“ Verificando archivos..."
            ls -la

            if [ ! -f nginx.conf ]; then
              echo "âŒ Error: nginx.conf no encontrado"
              exit 1
            fi

            if [ ! -f docker-swarm.yml ]; then
              echo "âŒ Error: docker-swarm.yml no encontrado"
              exit 1
            fi

            echo "âœ… Archivos encontrados correctamente"

            # Inicializar Docker Swarm si no estÃ¡ inicializado
            echo "ðŸ”„ Verificando Docker Swarm..."
            if ! docker node ls >/dev/null 2>&1; then
              echo "ðŸ“¡ Inicializando Docker Swarm..."
              docker swarm init --advertise-addr $(hostname -I | awk '{print $1}')
              echo "âœ… Docker Swarm inicializado"
            else
              echo "âœ… Docker Swarm ya estÃ¡ activo"
            fi

            # Exportar secretos como variables de entorno
            export POSTGRES_DB=${{ secrets.POSTGRES_DB }}
            export POSTGRES_USER=${{ secrets.POSTGRES_USER }}
            export POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            export GITHUB_REPOSITORY=${{ github.repository }}

            # Crear o reemplazar config para nginx
            echo "ðŸ”§ Configurando nginx..."
            docker config rm nginx_config 2>/dev/null || true
            docker config create nginx_config nginx.conf
            echo "âœ… Nginx config creado"

            # Pull de la imagen antes del despliegue (preheat)
            echo "ðŸ“¥ Descargando imagen..."
            docker pull ghcr.io/${{ github.repository }}:${{ env.DEPLOY_TAG }}
            echo "âœ… Imagen descargada"

            # Despliegue del stack
            echo "ðŸš€ Desplegando stack..."
            docker stack deploy -c docker-swarm.yml academianovit

            # Esperar un momento y verificar el estado
            sleep 5
            echo "ðŸ“Š Estado del stack:"
            docker stack services academianovit

            echo "âœ… Despliegue completado."

      - name: Send notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.DEBUGMAIL_HOST }}
          server_port: ${{ secrets.DEBUGMAIL_PORT }}
          username: ${{ secrets.DEBUGMAIL_USER }}
          password: ${{ secrets.DEBUGMAIL_PASS }}
          subject: "ðŸš€ Deploy a ProducciÃ³n ${{ job.status }}"
          body: |
            Se ha realizado el deploy a producciÃ³n.

            Imagen: ghcr.io/${{ github.repository }}:${{ env.DEPLOY_TAG }}
            Resultado: ${{ job.status }}
            Ver logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.EMAIL_TO }}
          from: ${{ secrets.DEBUGMAIL_USER }}
